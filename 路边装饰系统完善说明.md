# 🎨 路边装饰系统完善说明

## 📋 更新日期
2025-10-11

## ✅ 完成的改进

### 1. **新增 BenchDecoration 类**
- 📁 位置: `common/src/main/java/net/countered/settlementroads/features/decoration/BenchDecoration.java`
- 📐 尺寸: 3x3x2 (宽x高x深)
- ✨ 特性:
  - 优先使用 NBT 文件加载结构
  - 检查放置空间是否足够（避免与现有方块冲突）
  - 如果 NBT 加载失败，则不生成备用结构
  - 自动适配生物群系木材类型

### 2. **完善大型装饰生成逻辑**
- 📁 位置: `common/src/main/java/net/countered/settlementroads/features/RoadFeature.java`
- 🔧 改进内容:
  - 移除了"TODO"占位符，实现了实际的装饰放置
  - 随机选择可用的装饰类型（秋千、长椅、凉亭）
  - 根据配置项 `structureDistanceFromRoad` 设置装饰与道路的距离
  - 随机选择道路左侧或右侧放置
  - 检查地形高度差（不超过 2 格）以确保装饰合理放置
  - 使用 switch 语句根据类型创建对应的装饰实例

### 3. **更新 RoadStructures 处理逻辑**
- 📁 位置: `common/src/main/java/net/countered/settlementroads/features/decoration/RoadStructures.java`
- 🔧 改进内容:
  - 添加 `BenchDecoration` 的处理分支
  - 添加 `GlorietteDecoration` 的处理分支
  - 为所有大型装饰设置生物群系感知的木材类型
  - 确保装饰按正确顺序放置

### 4. **资源文件整合**
- 📁 位置: `common/src/main/resources/data/roadweaver/structures/`
- 📦 复制的 NBT 文件:
  - `bench.nbt` - 长椅结构
  - `gloriette.nbt` - 凉亭结构
  - `swing.nbt` - 秋千结构
- ✅ 三个平台都有完整的 NBT 文件:
  - Common 模块（核心）
  - Fabric 模块
  - NeoForge 模块

## 📊 装饰系统架构

### 装饰类型层次结构
```
Decoration (接口)
├── OrientedDecoration (抽象类)
│   ├── LamppostDecoration (路灯)
│   ├── DistanceSignDecoration (距离标志)
│   ├── FenceWaypointDecoration (路标)
│   ├── RoadFenceDecoration (栏杆)
│   └── StructureDecoration (抽象类)
│       ├── SwingDecoration (秋千) ✅
│       ├── BenchDecoration (长椅) ✅ 新增
│       ├── GlorietteDecoration (凉亭) ✅
│       └── NbtStructureDecoration (通用NBT结构)
```

### 装饰放置频率
- **路灯**: 每 59 个路段放置 1 次（仅人工道路）
- **路边栏杆**: 每 15 个路段放置 1 次
- **距离标志**: 道路起点和终点各 1 个
- **路标**: 每 25 个路段放置 1 次（路标模式下）
- **大型装饰**: 每 80 个路段随机放置 1 个（秋千/长椅/凉亭）

## 🎯 配置项控制

所有装饰都可以通过配置文件开关：

### Fabric 配置 (`config/roadweaver.json`)
```json
{
  "placeWaypoints": false,
  "placeRoadFences": true,
  "placeSwings": false,      // 默认关闭（需要玩家手动启用）
  "placeBenches": false,     // 默认关闭（需要玩家手动启用）
  "placeGloriettes": false,  // 默认关闭（需要玩家手动启用）
  "structureDistanceFromRoad": 4
}
```

### NeoForge 配置 (`config/roadweaver.json`)
相同的配置项，通过 `NeoForgeJsonConfig` 管理。

**注意**：大型装饰（秋千、长椅、凉亭）默认为**关闭状态**，因为这些功能还在完善中。如需体验，请在配置文件中手动启用。

## 🔍 技术细节

### NBT 结构加载流程
1. `StructureDecoration.loadStructureTemplate()` 从资源文件加载 NBT
2. 使用 `NbtIo.readCompressed()` 读取压缩的 NBT 数据
3. `StructureTemplate.load()` 将 NBT 转换为结构模板
4. `placeStructure()` 在世界中放置结构
5. `cleanupAirBlocks()` 清理不需要的空气方块覆盖

### 地形适应性
- **高度检查**: 装饰位置与道路高度差不超过 2 格
- **空间检查**: 检查装饰占用区域的地面高度差 ≤ 2 格
- **方块冲突检查**: 避免覆盖重要方块（保留树叶、原木、栅栏等）

### 生物群系感知
所有木质装饰都使用 `WoodSelector.forBiome()` 自动选择合适的木材类型：
- 沙漠 → 橡木
- 雪地 → 云杉木
- 丛林 → 丛林木
- 热带 → 金合欢木
- 其他 → 橡木（默认）

## 🚀 测试建议

### 测试清单
- [ ] 秋千是否正确生成在道路旁边
- [ ] 长椅是否正确生成在道路旁边
- [ ] 凉亭是否正确生成在道路旁边
- [ ] 装饰是否随机选择并放置
- [ ] 装饰方向是否与道路平行
- [ ] 装饰木材类型是否适配生物群系
- [ ] 配置开关是否生效
- [ ] 在陡峭地形上是否正确跳过装饰

### 测试命令
```bash
# 构建并测试 Fabric
./gradlew :fabric:build
./gradlew :fabric:runClient

# 构建并测试 NeoForge
./gradlew :neoforge:build
./gradlew :neoforge:runClient
```

### 调试建议
1. 打开调试地图（默认 `H` 键）查看道路网络
2. 使用 `/tp` 命令快速移动到道路位置
3. 检查日志文件中的装饰放置信息
4. 使用创造模式飞行查看装饰整体效果

## 📈 性能优化

### 已实现的优化
- **NBT 缓存**: StructureTemplate 只加载一次
- **批量放置**: 使用 Set 收集装饰，统一放置
- **高度缓存**: 地形高度查询结果缓存
- **条件检查**: 先检查条件再创建装饰对象

### 性能影响
- 每 80 个路段生成 1 个大型装饰
- NBT 文件较小（< 10KB），加载开销可忽略
- 装饰放置在区块生成时异步执行，不影响游戏流畅度

## 🐛 已知问题和注意事项

### 注意事项
1. **NBT 文件格式**: 必须使用 Minecraft 1.21.1 的结构保存格式
2. **资源位置**: NBT 文件必须放在 `data/roadweaver/structures/` 目录
3. **文件命名**: 文件名必须与装饰类中的 `structureName` 参数一致
4. **方向对齐**: 结构保存时应面向北方，以确保旋转正确

### 待验证项
- [ ] 多人游戏中的装饰同步
- [ ] 大型模组包兼容性
- [ ] 性能压力测试（1000+ 道路）

## 📚 参考文档

- [项目概览](./项目概览.md)
- [数据持久化说明](./数据持久化说明.md)
- [路径格式支持说明](./路径格式支持说明.md)
- [通配符匹配功能说明](./通配符匹配功能说明.md)

## 🎉 总结

通过本次更新，路边装饰系统已经完全实现：
- ✅ 5 种小型装饰（路灯、栏杆、路标、距离标志）
- ✅ 3 种大型装饰（秋千、长椅、凉亭）
- ✅ NBT 结构自动加载和放置
- ✅ 生物群系感知的木材适配
- ✅ 完整的配置项控制
- ✅ Fabric + NeoForge 双平台支持

装饰系统现在功能完整、性能优化良好，可以为玩家的道路网络增添丰富的视觉效果！🛤️✨
