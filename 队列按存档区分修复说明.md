# é˜Ÿåˆ—æŒ‰å­˜æ¡£åŒºåˆ†ä¿®å¤è¯´æ˜

## ğŸ› é—®é¢˜æè¿°

**åŸé—®é¢˜**: é“è·¯è¿æ¥é˜Ÿåˆ—ä½¿ç”¨å…¨å±€é™æ€å˜é‡ï¼Œæ²¡æœ‰æŒ‰å­˜æ¡£ï¼ˆä¸–ç•Œç»´åº¦ï¼‰åŒºåˆ†ï¼Œå¯¼è‡´ï¼š
1. å¤šä¸ªå­˜æ¡£ä¹‹é—´çš„é“è·¯è¿æ¥æ··ä¹±
2. åˆ‡æ¢å­˜æ¡£æ—¶é˜Ÿåˆ—æ•°æ®æ±¡æŸ“
3. ä¸åŒä¸–ç•Œçš„è¿æ¥å¯èƒ½è¢«é”™è¯¯åœ°åº”ç”¨åˆ°å…¶ä»–ä¸–ç•Œ

```java
// æ—§ä»£ç  - å…¨å±€é˜Ÿåˆ—
public static Queue<Records.StructureConnection> cachedStructureConnections = new ArrayDeque<>();
```

## âœ… è§£å†³æ–¹æ¡ˆ

### æ ¸å¿ƒæ”¹åŠ¨

å°†å…¨å±€é˜Ÿåˆ—æ”¹ä¸º**æŒ‰ä¸–ç•Œç»´åº¦é”®å€¼æ˜ å°„**çš„é˜Ÿåˆ—å­˜å‚¨ï¼š

```java
// æ–°ä»£ç  - æŒ‰ä¸–ç•ŒåŒºåˆ†çš„é˜Ÿåˆ—
private static final ConcurrentHashMap<String, Queue<Records.StructureConnection>> worldQueues = new ConcurrentHashMap<>();

public static Queue<Records.StructureConnection> getQueueForWorld(ServerLevel level) {
    String worldKey = level.dimension().location().toString();
    return worldQueues.computeIfAbsent(worldKey, k -> new ConcurrentLinkedQueue<>());
}
```

### å…³é”®æ”¹è¿›

1. **çº¿ç¨‹å®‰å…¨**: ä½¿ç”¨ `ConcurrentHashMap` å’Œ `ConcurrentLinkedQueue`
2. **è‡ªåŠ¨ç®¡ç†**: é€šè¿‡ `computeIfAbsent` è‡ªåŠ¨åˆ›å»ºé˜Ÿåˆ—
3. **æ¸…ç†æœºåˆ¶**: ä¸–ç•Œå¸è½½æ—¶è‡ªåŠ¨æ¸…ç†å¯¹åº”é˜Ÿåˆ—

## ğŸ“ ä¿®æ”¹æ–‡ä»¶æ¸…å•

### Common æ¨¡å—
- âœ… `StructureConnector.java` - æ ¸å¿ƒé˜Ÿåˆ—ç®¡ç†
- âœ… `ModEventHandler.java` - äº‹ä»¶å¤„ç†å™¨

### Fabric æ¨¡å—
- âœ… `ModEventHandler.java` - Fabric äº‹ä»¶å¤„ç†
- âœ… `RoadDebugScreen.java` - è°ƒè¯•ç•Œé¢

### NeoForge æ¨¡å—
- âœ… `RoadDebugScreen.java` - è°ƒè¯•ç•Œé¢

## ğŸ”§ è¯¦ç»†æ”¹åŠ¨

### 1. StructureConnector.java

#### æ–°å¢æ–¹æ³•
```java
/**
 * è·å–æŒ‡å®šä¸–ç•Œçš„è¿æ¥é˜Ÿåˆ—
 */
public static Queue<Records.StructureConnection> getQueueForWorld(ServerLevel level) {
    String worldKey = level.dimension().location().toString();
    return worldQueues.computeIfAbsent(worldKey, k -> new ConcurrentLinkedQueue<>());
}

/**
 * æ¸…ç†æŒ‡å®šä¸–ç•Œçš„é˜Ÿåˆ—
 */
public static void clearQueueForWorld(ServerLevel level) {
    String worldKey = level.dimension().location().toString();
    Queue<Records.StructureConnection> queue = worldQueues.remove(worldKey);
    if (queue != null) {
        queue.clear();
        LOGGER.debug("Cleared queue for world: {}", worldKey);
    }
}
```

#### ä¿®æ”¹ç‚¹
- åˆ›å»ºè¿æ¥æ—¶ä½¿ç”¨ `getQueueForWorld(serverWorld).add()`
- ç§»é™¤æ—§çš„å…¨å±€é˜Ÿåˆ—å˜é‡

### 2. ModEventHandler.java (Common)

#### ä¸–ç•Œå¸è½½äº‹ä»¶
```java
LifecycleEvent.SERVER_LEVEL_UNLOAD.register(level -> {
    // ... åŸæœ‰ä»£ç  ...
    // æ–°å¢: æ¸…ç†é˜Ÿåˆ—
    StructureConnector.clearQueueForWorld(level);
});
```

#### é“è·¯ç”Ÿæˆé€»è¾‘
```java
// æ—§ä»£ç 
if (!StructureConnector.cachedStructureConnections.isEmpty()) {
    Records.StructureConnection conn = StructureConnector.cachedStructureConnections.peek();
    // ...
}

// æ–°ä»£ç 
Queue<Records.StructureConnection> queue = StructureConnector.getQueueForWorld(level);
if (!queue.isEmpty()) {
    Records.StructureConnection conn = queue.peek();
    // ...
}
```

#### æ¢å¤æœªå®Œæˆä»»åŠ¡
```java
// æ—§ä»£ç 
StructureConnector.cachedStructureConnections.add(connection);

// æ–°ä»£ç 
StructureConnector.getQueueForWorld(level).add(connection);
```

### 3. Fabric ModEventHandler.java

åŒæ ·çš„ä¿®æ”¹æ¨¡å¼ï¼š
- ä½¿ç”¨ `getQueueForWorld(level)` æ›¿ä»£å…¨å±€é˜Ÿåˆ—
- æ·»åŠ  `import java.util.Queue;`

### 4. RoadDebugScreen.java (Fabric & NeoForge)

æ‰‹åŠ¨åˆ›å»ºè¿æ¥æ—¶ï¼š
```java
// æ—§ä»£ç 
StructureConnector.cachedStructureConnections.add(newConn);

// æ–°ä»£ç 
StructureConnector.getQueueForWorld(world).add(newConn);
```

## ğŸ¯ ä¼˜åŠ¿å¯¹æ¯”

| ç‰¹æ€§ | æ—§å®ç° | æ–°å®ç° |
|------|--------|--------|
| **å­˜æ¡£éš”ç¦»** | âŒ å…¨å±€å…±äº« | âœ… æŒ‰ä¸–ç•ŒåŒºåˆ† |
| **çº¿ç¨‹å®‰å…¨** | âŒ ArrayDeque (éçº¿ç¨‹å®‰å…¨) | âœ… ConcurrentLinkedQueue |
| **å†…å­˜ç®¡ç†** | âŒ æ‰‹åŠ¨æ¸…ç† | âœ… è‡ªåŠ¨æ¸…ç† |
| **å¤šä¸–ç•Œæ”¯æŒ** | âŒ ä¸æ”¯æŒ | âœ… å®Œå…¨æ”¯æŒ |
| **å¹¶å‘è®¿é—®** | âš ï¸ ä¾èµ–å•çº¿ç¨‹ | âœ… æ”¯æŒå¹¶å‘ |

## ğŸ” ä¸–ç•Œé”®å€¼æ ¼å¼

é˜Ÿåˆ—ä½¿ç”¨ä¸–ç•Œç»´åº¦çš„èµ„æºä½ç½®ä½œä¸ºé”®ï¼š
```
minecraft:overworld       â†’ ä¸»ä¸–ç•Œé˜Ÿåˆ—
minecraft:the_nether      â†’ ä¸‹ç•Œé˜Ÿåˆ—
minecraft:the_end         â†’ æœ«åœ°é˜Ÿåˆ—
modid:custom_dimension    â†’ è‡ªå®šä¹‰ç»´åº¦é˜Ÿåˆ—
```

## ğŸ§ª æµ‹è¯•åœºæ™¯

### åœºæ™¯ 1: å•å­˜æ¡£å¤šç»´åº¦
- âœ… ä¸»ä¸–ç•Œã€ä¸‹ç•Œã€æœ«åœ°å„è‡ªç‹¬ç«‹é˜Ÿåˆ—
- âœ… åˆ‡æ¢ç»´åº¦ä¸å½±å“å…¶ä»–ç»´åº¦çš„é˜Ÿåˆ—

### åœºæ™¯ 2: å¤šå­˜æ¡£åˆ‡æ¢
- âœ… å­˜æ¡£ A çš„é˜Ÿåˆ—ä¸ä¼šå½±å“å­˜æ¡£ B
- âœ… é‡æ–°åŠ è½½å­˜æ¡£æ—¶æ­£ç¡®æ¢å¤é˜Ÿåˆ—

### åœºæ™¯ 3: ä¸–ç•Œå¸è½½
- âœ… å¸è½½ä¸–ç•Œæ—¶è‡ªåŠ¨æ¸…ç†é˜Ÿåˆ—
- âœ… ä¸ä¼šé€ æˆå†…å­˜æ³„æ¼

## ğŸ“Š æ€§èƒ½å½±å“

- **å†…å­˜å¼€é”€**: æ¯ä¸ªä¸–ç•Œä¸€ä¸ªé˜Ÿåˆ—ï¼ˆå¯å¿½ç•¥ï¼‰
- **æŸ¥æ‰¾æ€§èƒ½**: `O(1)` HashMap æŸ¥æ‰¾
- **å¹¶å‘æ€§èƒ½**: æ— é”é˜Ÿåˆ—ï¼Œé«˜å¹¶å‘å‹å¥½

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **å‘åå…¼å®¹**: æ—§å­˜æ¡£é¦–æ¬¡åŠ è½½æ—¶ä¼šä»æŒä¹…åŒ–æ•°æ®æ¢å¤é˜Ÿåˆ—
2. **é˜Ÿåˆ—æŒä¹…åŒ–**: é˜Ÿåˆ—æœ¬èº«ä¸æŒä¹…åŒ–ï¼Œä¾èµ– `ConnectionStatus` æ¢å¤
3. **æ¸…ç†æ—¶æœº**: ä¸–ç•Œå¸è½½æ—¶æ¸…ç†ï¼ŒæœåŠ¡å™¨åœæ­¢æ—¶å…¨éƒ¨æ¸…ç†

## ğŸš€ åç»­ä¼˜åŒ–å»ºè®®

1. **ä¼˜å…ˆçº§é˜Ÿåˆ—**: æ‰‹åŠ¨è¿æ¥ä¼˜å…ˆäºè‡ªåŠ¨è¿æ¥
2. **é˜Ÿåˆ—å¤§å°é™åˆ¶**: é˜²æ­¢é˜Ÿåˆ—æ— é™å¢é•¿
3. **ç»Ÿè®¡ä¿¡æ¯**: æ·»åŠ é˜Ÿåˆ—ç›‘æ§å’Œç»Ÿè®¡

## ğŸ“Œ æ€»ç»“

æ­¤æ¬¡ä¿®å¤å½»åº•è§£å†³äº†é˜Ÿåˆ—å­˜å‚¨çš„æ¶æ„é—®é¢˜ï¼Œç¡®ä¿ï¼š
- âœ… æ¯ä¸ªä¸–ç•Œç‹¬ç«‹ç®¡ç†é“è·¯è¿æ¥é˜Ÿåˆ—
- âœ… çº¿ç¨‹å®‰å…¨çš„å¹¶å‘è®¿é—®
- âœ… è‡ªåŠ¨çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†
- âœ… å®Œæ•´çš„å¤šä¸–ç•Œæ”¯æŒ

ä¿®æ”¹åçš„ä»£ç æ›´åŠ å¥å£®ã€å¯ç»´æŠ¤ï¼Œä¸ºæœªæ¥çš„å¤šä¸–ç•Œç‰¹æ€§å¥ å®šäº†åŸºç¡€ã€‚
