# ç»“æ„é¢œè‰²ä¸åŠ¨æ€å›¾ä¾‹åŠŸèƒ½è¯´æ˜

## ğŸ¨ åŠŸèƒ½æ¦‚è¿°

å®ç°äº†ä¸‰ä¸ªä¸»è¦åŠŸèƒ½æ¥æ”¹å–„åœ°å›¾ä¸Šç»“æ„çš„å¯è§†åŒ–ï¼š

1. **ä¸ºæ¯ç§ç»“æ„åˆ†é…å”¯ä¸€é¢œè‰²** - ä¸åŒç±»å‹çš„ç»“æ„æ˜¾ç¤ºä¸åŒé¢œè‰²
2. **åŠ¨æ€å›¾ä¾‹** - å·¦ä¸‹è§’åªæ˜¾ç¤ºå½“å‰å±å¹•å¯è§èŒƒå›´å†…çš„ç»“æ„ç±»å‹
3. **é¼ æ ‡æ‚¬åœæç¤º** - é¼ æ ‡ç§»åˆ°ç»“æ„ç‚¹ä¸Šæ˜¾ç¤ºç»“æ„åç§°å’Œåæ ‡

## ğŸ“ å®ç°ç»†èŠ‚

### 1. ç»“æ„é¢œè‰²ç®¡ç†å™¨ (`StructureColorManager`)

**ä½ç½®**: `common/src/main/java/net/countered/settlementroads/client/gui/StructureColorManager.java`

**åŠŸèƒ½**:
- ä¸ºæ¯ç§ç»“æ„ç±»å‹è‡ªåŠ¨åˆ†é…å”¯ä¸€é¢œè‰²
- ä½¿ç”¨ 30 ç§é«˜å¯¹æ¯”åº¦ã€æ˜“åŒºåˆ†çš„é¢œè‰²è°ƒè‰²æ¿
- è‡ªåŠ¨ç”Ÿæˆç»“æ„çš„ç®€çŸ­æ˜¾ç¤ºåç§°

**é¢œè‰²è°ƒè‰²æ¿**:
```java
ç»¿è‰² 0xFF27AE60, è“è‰² 0xFF3498DB, çº¢è‰² 0xFFE74C3C, æ©™è‰² 0xFFF39C12,
ç´«è‰² 0xFF9B59B6, é’è‰² 0xFF1ABC9C, ç²‰è‰² 0xFFE91E63, é»„è‰² 0xFFFFEB3B,
... å…± 30 ç§é¢œè‰²
```

**æ˜¾ç¤ºåç§°å¤„ç†**:
- ç§»é™¤å‘½åç©ºé—´å‰ç¼€ï¼ˆå¦‚ `minecraft:`, `modid:`ï¼‰
- å°†ä¸‹åˆ’çº¿å’Œæ–œæ æ›¿æ¢ä¸ºç©ºæ ¼
- é™åˆ¶é•¿åº¦ä¸º 25 å­—ç¬¦
- ç¤ºä¾‹ï¼š`minecraft:village_plains` â†’ `village plains`

### 2. ç»“æ„æ•°æ®æ‰©å±• (`Records.StructureInfo`)

**ä½ç½®**: `common/src/main/java/net/countered/settlementroads/helpers/Records.java`

**æ–°å¢æ•°æ®ç»“æ„**:
```java
public record StructureInfo(BlockPos pos, String structureId) {
    // pos: ç»“æ„ä½ç½®
    // structureId: ç»“æ„ç±»å‹ IDï¼ˆå¦‚ "minecraft:village_plains"ï¼‰
}
```

**æ•°æ®å…¼å®¹æ€§**:
- æ–°å¢ `structureInfos` å­—æ®µå­˜å‚¨ç»“æ„ç±»å‹ä¿¡æ¯
- ä¿ç•™ `structureLocations` å­—æ®µå‘åå…¼å®¹
- ä½¿ç”¨ `optionalFieldOf` ç¡®ä¿æ—§å­˜æ¡£å¯ä»¥æ­£å¸¸åŠ è½½

### 3. ç»“æ„å®šä½å™¨æ›´æ–° (`StructureLocatorImpl`)

**ä½ç½®**: `common/src/main/java/net/countered/settlementroads/helpers/StructureLocatorImpl.java`

**ä¿®æ”¹å†…å®¹**:
```java
// ä¿å­˜ç»“æ„æ—¶åŒæ—¶ä¿å­˜ç±»å‹ä¿¡æ¯
Holder<Structure> structureHolder = result.getSecond();
String structureId = structureHolder.unwrapKey()
        .map(key -> key.location().toString())
        .orElse("unknown");
structureInfos.add(new Records.StructureInfo(structurePos, structureId));
```

### 4. åœ°å›¾æ¸²æŸ“å™¨æ›´æ–° (`MapRenderer`)

**ä½ç½®**: `fabric/neoforge/src/main/java/net/countered/settlementroads/client/gui/MapRenderer.java`

**ä¿®æ”¹å†…å®¹**:

#### æ„é€ å‡½æ•°
```java
public MapRenderer(Map<String, Integer> statusColors, 
                   RoadDebugScreen.ScreenBounds bounds, 
                   StructureColorManager colorManager) {
    this.colorManager = colorManager;
}
```

#### ç»˜åˆ¶ç»“æ„
```java
public void drawStructures(GuiGraphics ctx, 
                          List<Records.StructureInfo> structureInfos, ...) {
    for (Records.StructureInfo info : structureInfos) {
        String structureId = info.structureId();
        int structureColor = colorManager.getColorForStructure(structureId);
        
        // ä½¿ç”¨ç»“æ„ç‰¹å®šé¢œè‰²ç»˜åˆ¶
        RenderUtils.fillCircle(ctx, pos.x(), pos.y(), radius, structureColor);
        RenderUtils.drawCircleOutline(ctx, pos.x(), pos.y(), radius, darkenColor(structureColor));
    }
}
```

#### é¢œè‰²åŠ æ·±å‡½æ•°
```java
private int darkenColor(int color) {
    int r = ((color >> 16) & 0xFF) * 2 / 3;
    int g = ((color >> 8) & 0xFF) * 2 / 3;
    int b = (color & 0xFF) * 2 / 3;
    return 0xFF000000 | (r << 16) | (g << 8) | b;
}
```

### 5. UI æ¸²æŸ“å™¨æ›´æ–° (`UIRenderer`)

**ä½ç½®**: `fabric/neoforge/src/main/java/net/countered/settlementroads/client/gui/UIRenderer.java`

#### åŠ¨æ€å›¾ä¾‹
```java
public void drawLegendPanel(GuiGraphics ctx, int height, 
                           List<Records.StructureInfo> visibleStructureInfos) {
    // åªæ˜¾ç¤ºå½“å‰å¯è§èŒƒå›´å†…çš„ç»“æ„ç±»å‹
    Map<String, Integer> visibleStructureColors = new LinkedHashMap<>();
    for (Records.StructureInfo info : visibleStructureInfos) {
        String structureId = info.structureId();
        if (!visibleStructureColors.containsKey(structureId)) {
            visibleStructureColors.put(structureId, 
                colorManager.getColorForStructure(structureId));
        }
    }
    
    // ç»˜åˆ¶å¯è§ç»“æ„ç±»å‹å›¾ä¾‹
    for (Map.Entry<String, Integer> entry : visibleStructureColors.entrySet()) {
        String displayName = colorManager.getDisplayName(entry.getKey());
        int color = entry.getValue();
        
        RenderUtils.fillCircle(ctx, panelX + 12, currentY + 4, 3, color);
        ctx.drawString(font, displayName, panelX + 24, currentY, 0xFFFFFFFF, false);
    }
}
```

#### é¼ æ ‡æ‚¬åœæç¤º
```java
public void drawTooltip(GuiGraphics ctx, BlockPos structure, String structureId, 
                       int mouseX, int mouseY, int width) {
    String displayName = colorManager.getDisplayName(structureId);
    String posText = "ä½ç½®: " + structure.getX() + ", " + structure.getZ();
    
    int structureColor = colorManager.getColorForStructure(structureId);
    RenderUtils.drawPanel(ctx, x, y, x + tooltipWidth, y + tooltipHeight, 
                         0xF0000000, structureColor);
    
    ctx.drawString(font, displayName, x + 4, y + 5, 0xFFFFFFFF, true);
    ctx.drawString(font, posText, x + 4, y + 16, 0xFFAAAAAA, false);
}
```

### 6. è°ƒè¯•å±å¹•æ›´æ–° (`RoadDebugScreen`)

**ä½ç½®**: `fabric/neoforge/src/main/java/net/countered/settlementroads/client/gui/RoadDebugScreen.java`

#### å¯è§ç»“æ„è¿‡æ»¤
```java
private List<Records.StructureInfo> getVisibleStructures(
        MapRenderer.WorldToScreenConverter converter) {
    List<Records.StructureInfo> visible = new ArrayList<>();
    for (Records.StructureInfo info : structureInfos) {
        BlockPos pos = info.pos();
        ScreenPos screenPos = converter.worldToScreen(pos.getX(), pos.getZ());
        
        // æ£€æŸ¥æ˜¯å¦åœ¨å±å¹•èŒƒå›´å†…ï¼ˆå¸¦ 50 åƒç´ è¾¹è·ï¼‰
        if (screenPos.x >= -50 && screenPos.x <= width + 50 &&
            screenPos.y >= -50 && screenPos.y <= height + 50) {
            visible.add(info);
        }
    }
    return visible;
}
```

#### æ¸²æŸ“æµç¨‹
```java
// è¿‡æ»¤å¯è§ç»“æ„
List<Records.StructureInfo> visibleStructures = getVisibleStructures(converter);

// ä¼ é€’ç»™ UI æ¸²æŸ“å™¨
uiRenderer.drawLegendPanel(ctx, height, visibleStructures);
```

#### é¼ æ ‡æ‚¬åœæ£€æµ‹
```java
private void updateHoveredStructure(int mouseX, int mouseY) {
    Records.StructureInfo info = findClickedStructure(mouseX, mouseY);
    if (info != null) {
        hoveredStructure = info.pos();
        hoveredStructureId = info.structureId();
    } else {
        hoveredStructure = null;
        hoveredStructureId = null;
    }
}
```

## ğŸ¯ ä½¿ç”¨æ•ˆæœ

### ç»“æ„é¢œè‰²
- **æ‘åº„**: ç»¿è‰² (0xFF27AE60)
- **æ å¤ºè€…å‰å“¨ç«™**: è“è‰² (0xFF3498DB)
- **æ²™æ¼ ç¥æ®¿**: çº¢è‰² (0xFFE74C3C)
- **ä¸›æ—ç¥åº™**: æ©™è‰² (0xFFF39C12)
- **å…¶ä»–ç»“æ„**: è‡ªåŠ¨åˆ†é…ä¸åŒé¢œè‰²

### åŠ¨æ€å›¾ä¾‹
**ç¼©å°è§†å›¾**ï¼ˆæ˜¾ç¤ºå¤šä¸ªç»“æ„ç±»å‹ï¼‰:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â— village plainsâ”‚
â”‚ â— pillager out. â”‚
â”‚ â— desert pyramidâ”‚
â”‚ â— è®¡åˆ’ä¸­        â”‚
â”‚ â— ç”Ÿæˆä¸­        â”‚
â”‚ â— å¤±è´¥          â”‚
â”‚ â— é“è·¯          â”‚
â”‚ â— ç©å®¶          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ”¾å¤§è§†å›¾**ï¼ˆåªæ˜¾ç¤ºä¸€ç§ç»“æ„ï¼‰:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â— village plainsâ”‚
â”‚ â— è®¡åˆ’ä¸­        â”‚
â”‚ â— ç”Ÿæˆä¸­        â”‚
â”‚ â— å¤±è´¥          â”‚
â”‚ â— é“è·¯          â”‚
â”‚ â— ç©å®¶          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### é¼ æ ‡æ‚¬åœæç¤º
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ village plains     â”‚  â† ç»“æ„åç§°ï¼ˆåŠ ç²—ï¼‰
â”‚ ä½ç½®: 123, 456     â”‚  â† åæ ‡ï¼ˆç°è‰²ï¼‰
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
- è¾¹æ¡†é¢œè‰²ä¸ç»“æ„é¢œè‰²ä¸€è‡´
- è‡ªåŠ¨é¿å…è¶…å‡ºå±å¹•è¾¹ç•Œ

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### é¢œè‰²ç®¡ç†
- ä½¿ç”¨ `HashMap` ç¼“å­˜é¢œè‰²åˆ†é…
- åªåœ¨é¦–æ¬¡é‡åˆ°æ–°ç»“æ„ç±»å‹æ—¶è®¡ç®—é¢œè‰²
- æ—¶é—´å¤æ‚åº¦: O(1) æŸ¥è¯¢

### å¯è§ç»“æ„è¿‡æ»¤
- æ¯å¸§åªéå†ä¸€æ¬¡ç»“æ„åˆ—è¡¨
- ä½¿ç”¨ç®€å•çš„è¾¹ç•Œæ¡†æ£€æµ‹
- æ—¶é—´å¤æ‚åº¦: O(n)ï¼Œn ä¸ºç»“æ„æ€»æ•°

### å›¾ä¾‹æ¸²æŸ“
- ä½¿ç”¨ `LinkedHashMap` ä¿æŒæ’å…¥é¡ºåº
- è‡ªåŠ¨å»é‡ç›¸åŒç±»å‹çš„ç»“æ„
- åªæ¸²æŸ“å¯è§çš„ç»“æ„ç±»å‹

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### æ•°æ®æŒä¹…åŒ–
```java
public static final Codec<StructureLocationData> CODEC = RecordCodecBuilder.create(instance ->
    instance.group(
        BlockPos.CODEC.listOf().optionalFieldOf("structure_locations", new ArrayList<>())
            .forGetter(StructureLocationData::structureLocations),
        StructureInfo.CODEC.listOf().optionalFieldOf("structure_infos", new ArrayList<>())
            .forGetter(StructureLocationData::structureInfos)
    ).apply(instance, StructureLocationData::new)
);
```

### å‘åå…¼å®¹
- æ—§å­˜æ¡£åªæœ‰ `structure_locations`ï¼Œ`structure_infos` ä¸ºç©º
- æ–°å­˜æ¡£åŒæ—¶åŒ…å«ä¸¤ä¸ªå­—æ®µ
- æ—§ç»“æ„ä¼šæ˜¾ç¤ºä¸ºç°è‰²ï¼ˆæœªçŸ¥ç±»å‹ï¼‰

### å®¢æˆ·ç«¯æ•°æ®ä¼ é€’
```java
// Fabric
List<Records.StructureInfo> structureInfos = data != null ? 
    new ArrayList<>(data.structureInfos()) : new ArrayList<>();
client.setScreen(new RoadDebugScreen(structureInfos, connections, roads));

// NeoForge
List<Records.StructureInfo> structureInfos = structureData != null ?
    new ArrayList<>(structureData.structureInfos()) : new ArrayList<>();
client.execute(() -> client.setScreen(new RoadDebugScreen(structureInfos, connections, roads)));
```

## ğŸ¨ é¢œè‰²åˆ†é…ç­–ç•¥

### è°ƒè‰²æ¿è®¾è®¡åŸåˆ™
1. **é«˜å¯¹æ¯”åº¦**: ç¡®ä¿åœ¨æ·±è‰²èƒŒæ™¯ä¸Šæ¸…æ™°å¯è§
2. **é«˜é¥±å’Œåº¦**: é¢œè‰²é²œè‰³ï¼Œæ˜“äºåŒºåˆ†
3. **è‰²ç›¸åˆ†å¸ƒ**: è¦†ç›–æ•´ä¸ªè‰²è½®ï¼Œé¿å…ç›¸ä¼¼é¢œè‰²ç›¸é‚»
4. **äº®åº¦é€‚ä¸­**: é¿å…è¿‡æš—æˆ–è¿‡äº®çš„é¢œè‰²

### é¢œè‰²å¾ªç¯
- å½“ç»“æ„ç±»å‹è¶…è¿‡ 30 ç§æ—¶ï¼Œé¢œè‰²ä¼šå¾ªç¯ä½¿ç”¨
- ä½¿ç”¨æ¨¡è¿ç®—: `colorPalette.get(nextColorIndex % colorPalette.size())`

### æœªçŸ¥ç»“æ„
- é¢œè‰²: ç°è‰² (0xFF808080)
- æ˜¾ç¤ºåç§°: "æœªçŸ¥ç»“æ„"
- é€‚ç”¨äºæ— æ³•è·å–ç±»å‹ä¿¡æ¯çš„ç»“æ„

## ğŸš€ æœªæ¥ä¼˜åŒ–æ–¹å‘

### 1. è‡ªå®šä¹‰é¢œè‰²
å…è®¸ç”¨æˆ·åœ¨é…ç½®æ–‡ä»¶ä¸­è‡ªå®šä¹‰ç»“æ„é¢œè‰²ï¼š
```json
{
  "structureColors": {
    "minecraft:village_plains": "#27AE60",
    "minecraft:pillager_outpost": "#E74C3C"
  }
}
```

### 2. é¢œè‰²ä¸»é¢˜
æä¾›å¤šç§é¢œè‰²ä¸»é¢˜ï¼š
- é»˜è®¤ä¸»é¢˜ï¼ˆé«˜å¯¹æ¯”åº¦ï¼‰
- æŸ”å’Œä¸»é¢˜ï¼ˆä½é¥±å’Œåº¦ï¼‰
- è‰²ç›²å‹å¥½ä¸»é¢˜

### 3. å›¾ä¾‹åˆ†ç»„
æŒ‰æ¨¡ç»„æˆ–ç±»åˆ«åˆ†ç»„æ˜¾ç¤ºï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Minecraft       â”‚
â”‚ â— village       â”‚
â”‚ â— pillager out. â”‚
â”‚                 â”‚
â”‚ Mod: MVS        â”‚
â”‚ â— houses        â”‚
â”‚ â— shops         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4. æœç´¢è¿‡æ»¤
åœ¨å›¾ä¾‹ä¸­æ·»åŠ æœç´¢æ¡†ï¼Œå¿«é€Ÿå®šä½ç‰¹å®šç»“æ„ç±»å‹ã€‚

### 5. ç»Ÿè®¡ä¿¡æ¯
åœ¨å›¾ä¾‹ä¸­æ˜¾ç¤ºæ¯ç§ç»“æ„çš„æ•°é‡ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â— village (12)  â”‚
â”‚ â— pillager (3)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“– æ€»ç»“

æ­¤æ¬¡æ›´æ–°å®ç°äº†ï¼š
- âœ… æ¯ç§ç»“æ„ç±»å‹åˆ†é…å”¯ä¸€é¢œè‰²
- âœ… åŠ¨æ€å›¾ä¾‹ï¼Œåªæ˜¾ç¤ºå¯è§ç»“æ„
- âœ… é¼ æ ‡æ‚¬åœæ˜¾ç¤ºç»“æ„åç§°å’Œåæ ‡
- âœ… å‘åå…¼å®¹æ—§å­˜æ¡£
- âœ… Fabric å’Œ NeoForge åŒå¹³å°æ”¯æŒ

**æ•ˆæœ**:
- åœ°å›¾ä¸Šçš„ç»“æ„ç‚¹ç°åœ¨å¯ä»¥é€šè¿‡é¢œè‰²å¿«é€ŸåŒºåˆ†
- å›¾ä¾‹ä¼šæ ¹æ®å½“å‰è§†å›¾åŠ¨æ€æ›´æ–°ï¼Œé¿å…ä¿¡æ¯è¿‡è½½
- é¼ æ ‡æ‚¬åœæä¾›è¯¦ç»†ä¿¡æ¯ï¼Œæ— éœ€ç‚¹å‡»

**æ€§èƒ½**:
- é¢œè‰²æŸ¥è¯¢: O(1)
- å¯è§ç»“æ„è¿‡æ»¤: O(n)
- å›¾ä¾‹æ¸²æŸ“: O(k)ï¼Œk ä¸ºå¯è§ç»“æ„ç±»å‹æ•°

ç°åœ¨åœ°å›¾åŠŸèƒ½æ›´åŠ å¼ºå¤§å’Œæ˜“ç”¨ï¼ğŸ‰
