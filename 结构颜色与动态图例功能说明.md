# 结构颜色与动态图例功能说明

## 🎨 功能概述

实现了三个主要功能来改善地图上结构的可视化：

1. **为每种结构分配唯一颜色** - 不同类型的结构显示不同颜色
2. **动态图例** - 左下角只显示当前屏幕可见范围内的结构类型
3. **鼠标悬停提示** - 鼠标移到结构点上显示结构名称和坐标

## 📝 实现细节

### 1. 结构颜色管理器 (`StructureColorManager`)

**位置**: `common/src/main/java/net/countered/settlementroads/client/gui/StructureColorManager.java`

**功能**:
- 为每种结构类型自动分配唯一颜色
- 使用 30 种高对比度、易区分的颜色调色板
- 自动生成结构的简短显示名称

**颜色调色板**:
```java
绿色 0xFF27AE60, 蓝色 0xFF3498DB, 红色 0xFFE74C3C, 橙色 0xFFF39C12,
紫色 0xFF9B59B6, 青色 0xFF1ABC9C, 粉色 0xFFE91E63, 黄色 0xFFFFEB3B,
... 共 30 种颜色
```

**显示名称处理**:
- 移除命名空间前缀（如 `minecraft:`, `modid:`）
- 将下划线和斜杠替换为空格
- 限制长度为 25 字符
- 示例：`minecraft:village_plains` → `village plains`

### 2. 结构数据扩展 (`Records.StructureInfo`)

**位置**: `common/src/main/java/net/countered/settlementroads/helpers/Records.java`

**新增数据结构**:
```java
public record StructureInfo(BlockPos pos, String structureId) {
    // pos: 结构位置
    // structureId: 结构类型 ID（如 "minecraft:village_plains"）
}
```

**数据兼容性**:
- 新增 `structureInfos` 字段存储结构类型信息
- 保留 `structureLocations` 字段向后兼容
- 使用 `optionalFieldOf` 确保旧存档可以正常加载

### 3. 结构定位器更新 (`StructureLocatorImpl`)

**位置**: `common/src/main/java/net/countered/settlementroads/helpers/StructureLocatorImpl.java`

**修改内容**:
```java
// 保存结构时同时保存类型信息
Holder<Structure> structureHolder = result.getSecond();
String structureId = structureHolder.unwrapKey()
        .map(key -> key.location().toString())
        .orElse("unknown");
structureInfos.add(new Records.StructureInfo(structurePos, structureId));
```

### 4. 地图渲染器更新 (`MapRenderer`)

**位置**: `fabric/neoforge/src/main/java/net/countered/settlementroads/client/gui/MapRenderer.java`

**修改内容**:

#### 构造函数
```java
public MapRenderer(Map<String, Integer> statusColors, 
                   RoadDebugScreen.ScreenBounds bounds, 
                   StructureColorManager colorManager) {
    this.colorManager = colorManager;
}
```

#### 绘制结构
```java
public void drawStructures(GuiGraphics ctx, 
                          List<Records.StructureInfo> structureInfos, ...) {
    for (Records.StructureInfo info : structureInfos) {
        String structureId = info.structureId();
        int structureColor = colorManager.getColorForStructure(structureId);
        
        // 使用结构特定颜色绘制
        RenderUtils.fillCircle(ctx, pos.x(), pos.y(), radius, structureColor);
        RenderUtils.drawCircleOutline(ctx, pos.x(), pos.y(), radius, darkenColor(structureColor));
    }
}
```

#### 颜色加深函数
```java
private int darkenColor(int color) {
    int r = ((color >> 16) & 0xFF) * 2 / 3;
    int g = ((color >> 8) & 0xFF) * 2 / 3;
    int b = (color & 0xFF) * 2 / 3;
    return 0xFF000000 | (r << 16) | (g << 8) | b;
}
```

### 5. UI 渲染器更新 (`UIRenderer`)

**位置**: `fabric/neoforge/src/main/java/net/countered/settlementroads/client/gui/UIRenderer.java`

#### 动态图例
```java
public void drawLegendPanel(GuiGraphics ctx, int height, 
                           List<Records.StructureInfo> visibleStructureInfos) {
    // 只显示当前可见范围内的结构类型
    Map<String, Integer> visibleStructureColors = new LinkedHashMap<>();
    for (Records.StructureInfo info : visibleStructureInfos) {
        String structureId = info.structureId();
        if (!visibleStructureColors.containsKey(structureId)) {
            visibleStructureColors.put(structureId, 
                colorManager.getColorForStructure(structureId));
        }
    }
    
    // 绘制可见结构类型图例
    for (Map.Entry<String, Integer> entry : visibleStructureColors.entrySet()) {
        String displayName = colorManager.getDisplayName(entry.getKey());
        int color = entry.getValue();
        
        RenderUtils.fillCircle(ctx, panelX + 12, currentY + 4, 3, color);
        ctx.drawString(font, displayName, panelX + 24, currentY, 0xFFFFFFFF, false);
    }
}
```

#### 鼠标悬停提示
```java
public void drawTooltip(GuiGraphics ctx, BlockPos structure, String structureId, 
                       int mouseX, int mouseY, int width) {
    String displayName = colorManager.getDisplayName(structureId);
    String posText = "位置: " + structure.getX() + ", " + structure.getZ();
    
    int structureColor = colorManager.getColorForStructure(structureId);
    RenderUtils.drawPanel(ctx, x, y, x + tooltipWidth, y + tooltipHeight, 
                         0xF0000000, structureColor);
    
    ctx.drawString(font, displayName, x + 4, y + 5, 0xFFFFFFFF, true);
    ctx.drawString(font, posText, x + 4, y + 16, 0xFFAAAAAA, false);
}
```

### 6. 调试屏幕更新 (`RoadDebugScreen`)

**位置**: `fabric/neoforge/src/main/java/net/countered/settlementroads/client/gui/RoadDebugScreen.java`

#### 可见结构过滤
```java
private List<Records.StructureInfo> getVisibleStructures(
        MapRenderer.WorldToScreenConverter converter) {
    List<Records.StructureInfo> visible = new ArrayList<>();
    for (Records.StructureInfo info : structureInfos) {
        BlockPos pos = info.pos();
        ScreenPos screenPos = converter.worldToScreen(pos.getX(), pos.getZ());
        
        // 检查是否在屏幕范围内（带 50 像素边距）
        if (screenPos.x >= -50 && screenPos.x <= width + 50 &&
            screenPos.y >= -50 && screenPos.y <= height + 50) {
            visible.add(info);
        }
    }
    return visible;
}
```

#### 渲染流程
```java
// 过滤可见结构
List<Records.StructureInfo> visibleStructures = getVisibleStructures(converter);

// 传递给 UI 渲染器
uiRenderer.drawLegendPanel(ctx, height, visibleStructures);
```

#### 鼠标悬停检测
```java
private void updateHoveredStructure(int mouseX, int mouseY) {
    Records.StructureInfo info = findClickedStructure(mouseX, mouseY);
    if (info != null) {
        hoveredStructure = info.pos();
        hoveredStructureId = info.structureId();
    } else {
        hoveredStructure = null;
        hoveredStructureId = null;
    }
}
```

## 🎯 使用效果

### 结构颜色
- **村庄**: 绿色 (0xFF27AE60)
- **掠夺者前哨站**: 蓝色 (0xFF3498DB)
- **沙漠神殿**: 红色 (0xFFE74C3C)
- **丛林神庙**: 橙色 (0xFFF39C12)
- **其他结构**: 自动分配不同颜色

### 动态图例
**缩小视图**（显示多个结构类型）:
```
┌─────────────────┐
│ ● village plains│
│ ● pillager out. │
│ ● desert pyramid│
│ ● 计划中        │
│ ● 生成中        │
│ ● 失败          │
│ ● 道路          │
│ ● 玩家          │
└─────────────────┘
```

**放大视图**（只显示一种结构）:
```
┌─────────────────┐
│ ● village plains│
│ ● 计划中        │
│ ● 生成中        │
│ ● 失败          │
│ ● 道路          │
│ ● 玩家          │
└─────────────────┘
```

### 鼠标悬停提示
```
┌────────────────────┐
│ village plains     │  ← 结构名称（加粗）
│ 位置: 123, 456     │  ← 坐标（灰色）
└────────────────────┘
```
- 边框颜色与结构颜色一致
- 自动避免超出屏幕边界

## 📊 性能优化

### 颜色管理
- 使用 `HashMap` 缓存颜色分配
- 只在首次遇到新结构类型时计算颜色
- 时间复杂度: O(1) 查询

### 可见结构过滤
- 每帧只遍历一次结构列表
- 使用简单的边界框检测
- 时间复杂度: O(n)，n 为结构总数

### 图例渲染
- 使用 `LinkedHashMap` 保持插入顺序
- 自动去重相同类型的结构
- 只渲染可见的结构类型

## 🔧 技术细节

### 数据持久化
```java
public static final Codec<StructureLocationData> CODEC = RecordCodecBuilder.create(instance ->
    instance.group(
        BlockPos.CODEC.listOf().optionalFieldOf("structure_locations", new ArrayList<>())
            .forGetter(StructureLocationData::structureLocations),
        StructureInfo.CODEC.listOf().optionalFieldOf("structure_infos", new ArrayList<>())
            .forGetter(StructureLocationData::structureInfos)
    ).apply(instance, StructureLocationData::new)
);
```

### 向后兼容
- 旧存档只有 `structure_locations`，`structure_infos` 为空
- 新存档同时包含两个字段
- 旧结构会显示为灰色（未知类型）

### 客户端数据传递
```java
// Fabric
List<Records.StructureInfo> structureInfos = data != null ? 
    new ArrayList<>(data.structureInfos()) : new ArrayList<>();
client.setScreen(new RoadDebugScreen(structureInfos, connections, roads));

// NeoForge
List<Records.StructureInfo> structureInfos = structureData != null ?
    new ArrayList<>(structureData.structureInfos()) : new ArrayList<>();
client.execute(() -> client.setScreen(new RoadDebugScreen(structureInfos, connections, roads)));
```

## 🎨 颜色分配策略

### 调色板设计原则
1. **高对比度**: 确保在深色背景上清晰可见
2. **高饱和度**: 颜色鲜艳，易于区分
3. **色相分布**: 覆盖整个色轮，避免相似颜色相邻
4. **亮度适中**: 避免过暗或过亮的颜色

### 颜色循环
- 当结构类型超过 30 种时，颜色会循环使用
- 使用模运算: `colorPalette.get(nextColorIndex % colorPalette.size())`

### 未知结构
- 颜色: 灰色 (0xFF808080)
- 显示名称: "未知结构"
- 适用于无法获取类型信息的结构

## 🚀 未来优化方向

### 1. 自定义颜色
允许用户在配置文件中自定义结构颜色：
```json
{
  "structureColors": {
    "minecraft:village_plains": "#27AE60",
    "minecraft:pillager_outpost": "#E74C3C"
  }
}
```

### 2. 颜色主题
提供多种颜色主题：
- 默认主题（高对比度）
- 柔和主题（低饱和度）
- 色盲友好主题

### 3. 图例分组
按模组或类别分组显示：
```
┌─────────────────┐
│ Minecraft       │
│ ● village       │
│ ● pillager out. │
│                 │
│ Mod: MVS        │
│ ● houses        │
│ ● shops         │
└─────────────────┘
```

### 4. 搜索过滤
在图例中添加搜索框，快速定位特定结构类型。

### 5. 统计信息
在图例中显示每种结构的数量：
```
┌─────────────────┐
│ ● village (12)  │
│ ● pillager (3)  │
└─────────────────┘
```

## 📖 总结

此次更新实现了：
- ✅ 每种结构类型分配唯一颜色
- ✅ 动态图例，只显示可见结构
- ✅ 鼠标悬停显示结构名称和坐标
- ✅ 向后兼容旧存档
- ✅ Fabric 和 NeoForge 双平台支持

**效果**:
- 地图上的结构点现在可以通过颜色快速区分
- 图例会根据当前视图动态更新，避免信息过载
- 鼠标悬停提供详细信息，无需点击

**性能**:
- 颜色查询: O(1)
- 可见结构过滤: O(n)
- 图例渲染: O(k)，k 为可见结构类型数

现在地图功能更加强大和易用！🎉
