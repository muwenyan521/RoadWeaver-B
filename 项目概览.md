# 🛤️ RoadWeaver 项目详细概览

## 📋 项目基本信息

### 项目简介
**RoadWeaver** 是一个 Minecraft 1.21.1 模组，能够在世界中的结构（如村庄）之间自动生成美观的道路网络。该项目采用 **Architectury** 多平台架构，同时支持 **Fabric** 和 **NeoForge** 两大模组加载器。

### 技术栈
- **Minecraft 版本**: 1.21.1
- **Java 版本**: 21
- **构建工具**: Gradle 8.x
- **模组加载器**: Fabric 0.16.10 / NeoForge 21.1.169
- **架构框架**: Architectury 3.4
- **配置系统**: Cloth Config API 15.0.140
- **开发映射**: Mojang Official Mappings

### 项目结构
```
RoadWeaver/
├── common/          # 跨平台核心逻辑
│   └── src/main/java/net/countered/settlementroads/
│       ├── client/gui/           # GUI 组件（颜色管理）
│       ├── config/               # 配置接口
│       ├── events/               # 事件处理器
│       ├── features/             # 核心功能
│       │   ├── config/           # 特性配置
│       │   ├── decoration/       # 装饰系统
│       │   └── roadlogic/        # 道路生成逻辑
│       ├── helpers/              # 工具类
│       └── persistence/          # 数据持久化
├── fabric/          # Fabric 平台实现
│   └── src/main/
│       ├── java/                 # Fabric 特定代码
│       └── resources/            # 资源文件
├── neoforge/        # NeoForge 平台实现
│   └── src/main/
│       ├── java/                 # NeoForge 特定代码
│       └── resources/            # 资源文件
└── gradle/          # Gradle 配置
```

---

## 🎯 核心功能模块

### 1. 智能路径生成系统

#### A* 寻路算法 (`RoadPathCalculator.java`)
- **算法特点**:
  - 基于 A* 算法，考虑多维度成本
  - 网格对齐（4格间距），减少计算量
  - 支持 8 方向移动（东西南北 + 4 个对角线）
  
- **成本计算**:
  ```java
  总成本 = 步进成本 + 高度差成本 + 生物群系成本 + 海平面成本 + 地形稳定性成本
  
  - 步进成本: 直线=1, 对角线=1.5
  - 高度差成本: elevation × 40
  - 生物群系成本: 水域 × 50 × 8 (可配置忽略)
  - 海平面成本: 20 × 8 (避免在海平面生成)
  - 地形稳定性: 四周高度差总和 × 16
  ```

- **优化机制**:
  - **高度缓存**: `ConcurrentHashMap<Long, Integer>` 缓存地形高度
  - **插值路径**: 节点间自动插值，路径更平滑
  - **提前终止**: 接近目标时提前结束搜索

#### 道路类型
- **人工道路** (roadType = 0):
  - 材料: 泥砖、磨制安山岩、石砖等
  - 适用场景: 城镇连接
  
- **自然道路** (roadType = 1):
  - 材料: 粗泥、砂砾、草径等
  - 适用场景: 野外路径

### 2. 结构定位与连接系统

#### 结构搜寻 (`StructureLocator` + `StructureLocatorImpl`)
- **平台桥接**: 使用 `@ExpectPlatform` 实现跨平台
- **搜寻策略**:
  - 初始化时搜寻 N 个结构（默认 7 个）
  - 每隔一定距离触发新搜寻（默认 100 区块）
  - 支持标签和 ID 两种匹配方式
  
- **数据结构**:
  ```java
  record StructureInfo(BlockPos pos, String structureId)
  record StructureLocationData(List<BlockPos>, List<StructureInfo>)
  ```

#### 连接管理 (`StructureConnector`)
- **队列系统**: 按世界维度区分的并发队列
  ```java
  ConcurrentHashMap<String, Queue<StructureConnection>> worldQueues
  ```
  
- **连接状态**:
  - `PLANNED`: 计划中（待生成）
  - `GENERATING`: 生成中
  - `COMPLETED`: 已完成
  - `FAILED`: 生成失败

- **自动连接**: 新结构自动连接到最近的已知结构

### 3. 装饰系统

#### 装饰类型
1. **路灯** (`LamppostDecoration`):
   - 基座: 圆石深板岩墙
   - 支柱: 云杉木栏杆
   - 灯具: 红石灯 + 云杉木活板门灯罩
   - 控制: 反相阳光检测器（夜晚自动点亮）

2. **路边栏杆** (`RoadFenceDecoration`):
   - 间断式设计（1-3 格随机长度）
   - 根据生物群系选择木材类型

3. **距离标志** (`DistanceSignDecoration`):
   - 显示道路长度信息
   - 放置在道路起点和终点

4. **路标** (`FenceWaypointDecoration`):
   - 栅栏路标指引方向

5. **大型结构** (`NbtStructureDecoration`):
   - 秋千 (`SwingDecoration`)
   - 长椅 (待实现)
   - 凉亭 (待实现)

#### 装饰放置规则 (`RoadPlacementRules`)
- 生物群系感知: 根据生物群系选择合适的木材
- 高度检查: 确保装饰与道路高度差不超过 1 格
- 间隔控制: 不同装饰有不同的放置间隔

### 4. 数据持久化系统

#### 平台实现
**Fabric** (`FabricWorldDataProvider`):
- 使用 **Fabric Attachment API**
- 数据保存位置: `saves/<世界名>/data/attachments/`
- 自动序列化/反序列化

**NeoForge** (`NeoForgeWorldDataProvider`):
- 使用 **SavedData 系统**
- 数据保存位置: `saves/<世界名>/data/roadweaver_*.dat`
- 手动 NBT 序列化

#### 持久化数据
1. **结构位置数据**: 所有已发现的结构位置和类型
2. **结构连接数据**: 结构间的连接关系和状态
3. **道路数据**: 道路路径、材料、宽度等完整信息

### 5. 多线程生成系统

#### 线程池配置 (`ModEventHandler`)
- **线程池大小**: 128 线程（可配置）
- **并发上限**: 128 个同时生成任务（可配置）
- **任务管理**: `ConcurrentHashMap<String, Future<?>>` 追踪运行中的任务

#### 生成流程
```
1. 世界加载 → 初始化结构搜寻
2. 服务器 Tick → 检查队列
3. 队列非空 → 提交异步任务
4. 异步线程 → 执行 A* 路径计算
5. 路径完成 → 保存到 WorldData
6. 区块生成 → 放置道路方块和装饰
```

#### 并发控制
- **初始化延迟**: 世界加载后延迟 100 ticks（5秒）再开始生成
- **注册表检查**: 确保 ConfiguredFeature 注册表就绪
- **任务恢复**: 世界重新加载时恢复未完成的任务
- **失败处理**: 异常时标记连接为 FAILED，避免无限重试

---

## 🎨 客户端功能

### 调试地图界面 (`RoadDebugScreen`)
- **功能**:
  - 实时显示所有结构位置
  - 显示结构间的连接关系
  - 显示道路路径
  - 状态颜色编码（计划中/生成中/已完成/失败）
  
- **交互**:
  - 拖拽移动视图
  - 滚轮缩放
  - 点击结构传送（创造模式）
  - 手动创建连接
  - 刷新数据按钮

- **快捷键**: 默认 `H` 键打开（Fabric）

### 配置界面 (`ClothConfigScreen`)
- **集成**: ModMenu（Fabric）/ 配置文件（NeoForge）
- **配置项**:
  - 结构搜寻设置
  - 道路生成参数
  - 装饰开关
  - 性能控制

---

## 🔧 配置系统

### 配置接口 (`IModConfig`)
```java
public interface IModConfig {
    // 结构设置
    List<String> structuresToLocate();
    int structureSearchRadius();
    
    // 预生成设置
    int initialLocatingCount();
    int maxConcurrentRoadGeneration();
    int structureSearchTriggerDistance();
    
    // 道路设置
    int averagingRadius();
    boolean allowArtificial();
    boolean allowNatural();
    int maxHeightDifference();
    int maxTerrainStability();
    
    // 装饰设置
    boolean placeWaypoints();
    boolean placeRoadFences();
    boolean placeSwings();
    boolean placeBenches();
    boolean placeGloriettes();
    
    // 手动连接设置
    int manualMaxHeightDifference();
    int manualMaxTerrainStability();
    boolean manualIgnoreWater();
}
```

### 平台实现
- **Fabric**: `FabricModConfig` (使用 MidnightLib)
- **NeoForge**: `NeoForgeJsonConfig` (JSON 配置文件)

### 默认配置
```json
{
  "structuresToLocate": ["#minecraft:village"],
  "structureSearchRadius": 100,
  "initialLocatingCount": 7,
  "maxConcurrentRoadGeneration": 128,
  "structureSearchTriggerDistance": 100,
  "averagingRadius": 1,
  "allowArtificial": true,
  "allowNatural": true,
  "maxHeightDifference": 5,
  "maxTerrainStability": 4,
  "placeRoadFences": true,
  "placeSwings": true,
  "placeBenches": true,
  "placeGloriettes": true,
  "manualMaxHeightDifference": 10,
  "manualMaxTerrainStability": 8,
  "manualIgnoreWater": true
}
```

---

## 🏗️ 架构设计

### Architectury 多平台架构

#### Common 模块
- **职责**: 核心逻辑、算法、数据结构
- **特点**: 平台无关，使用 Architectury API
- **桥接**: `@ExpectPlatform` 注解实现平台特定功能

#### Fabric 模块
- **职责**: Fabric 特定实现、事件绑定、数据生成
- **特点**: 使用 Fabric API 和 Attachment API
- **入口**: `SettlementRoads` (主类), `SettlementRoadsClient` (客户端)

#### NeoForge 模块
- **职责**: NeoForge 特定实现、事件绑定、数据生成
- **特点**: 使用 NeoForge API 和 SavedData
- **入口**: `SettlementRoads` (主类), `SettlementRoadsClient` (客户端)

### 事件系统

#### Architectury Events (Common)
```java
LifecycleEvent.SERVER_LEVEL_LOAD    // 世界加载
LifecycleEvent.SERVER_LEVEL_UNLOAD  // 世界卸载
TickEvent.SERVER_PRE                // 服务器 Tick
LifecycleEvent.SERVER_STOPPING      // 服务器停止
```

#### 平台特定事件
- **Fabric**: `ServerLifecycleEvents`, `ServerTickEvents`
- **NeoForge**: `ServerLifecycleEvent`, `ServerTickEvent`

### 数据流转

```
玩家探索世界
    ↓
区块生成触发 RoadFeature
    ↓
StructureLocator 搜寻新结构
    ↓
StructureConnector 创建连接
    ↓
连接加入队列 (按世界区分)
    ↓
服务器 Tick 检查队列
    ↓
提交异步任务到线程池
    ↓
Road.generateRoad() 执行 A* 算法
    ↓
RoadPathCalculator 计算路径
    ↓
保存 RoadData 到 WorldDataProvider
    ↓
区块生成时 RoadFeature.place()
    ↓
放置道路方块和装饰
```

---

## 📊 性能优化

### 1. 高度缓存
```java
Map<Long, Integer> heightCache = new ConcurrentHashMap<>();
```
- 缓存地形高度查询结果
- 避免重复调用 `getBaseHeight()`
- 定期清理（超过 100,000 条目）

### 2. 多线程生成
- 128 个工作线程并行计算路径
- 主线程仅负责方块放置
- 避免阻塞游戏 Tick

### 3. 并发控制
- 可配置的并发上限
- 任务队列管理
- 自动清理已完成任务

### 4. 网格对齐
- 路径节点对齐到 4 格网格
- 减少 A* 搜索空间
- 提升计算效率

### 5. 提前终止
- 接近目标时提前结束搜索
- 避免不必要的计算

---

## 🌍 多世界支持

### 维度隔离
- 每个世界维度独立的队列
- 独立的数据存储
- 自动生命周期管理

### 支持的维度
- 主世界 (`minecraft:overworld`)
- 下界 (`minecraft:the_nether`)
- 末地 (`minecraft:the_end`)
- 自定义维度

---

## 🐛 已知问题和修复

### 已修复
1. ✅ 结构搜寻功能失效 → 修复平台实现和参数
2. ✅ 不可变集合异常 → 创建可变副本
3. ✅ 队列全局共享 → 按世界区分队列
4. ✅ 并发控制问题 → 增强任务恢复和失败处理
5. ✅ 注册表未就绪 → 添加初始化延迟和检查

### 待实现
1. ⏳ 长椅和凉亭的 NBT 结构
2. ⏳ NeoForge 平台完整测试
3. ⏳ 多人游戏调试地图支持

---

## 📚 文档清单

### 项目文档
- `README.md` - 项目介绍和使用说明
- `CHANGELOG.md` - 更新日志
- `LICENSE` - 许可证 (MIT)

### 技术文档
- `数据持久化说明.md` - 数据存储机制
- `线程池优化说明.md` - 性能优化详解
- `队列按存档区分修复说明.md` - 队列系统修复
- `道路搜寻与队列逻辑分析.md` - 核心逻辑分析
- `路径格式支持说明.md` - 路径匹配规则
- `通配符匹配功能说明.md` - 通配符支持
- `结构颜色与动态图例功能说明.md` - GUI 功能

---

## 🚀 构建和开发

### 构建命令
```bash
# 构建所有平台
./gradlew build

# 仅构建 Fabric
./gradlew :fabric:build

# 仅构建 NeoForge
./gradlew :neoforge:build

# 运行客户端 (Fabric)
./gradlew :fabric:runClient

# 运行客户端 (NeoForge)
./gradlew :neoforge:runClient

# 数据生成 (NeoForge)
./gradlew :neoforge:runData
```

### 开发环境
- **IDE**: IntelliJ IDEA / Eclipse
- **JDK**: Java 21
- **Gradle**: 8.x (使用 wrapper)

### 依赖管理
- Fabric API: 0.115.1+1.21.1
- NeoForge: 21.1.169
- Architectury: 13.0.8
- Cloth Config: 15.0.140

---

## 🎯 未来计划

### 短期目标
1. 完成所有装饰结构的 NBT 实现
2. 完善 NeoForge 平台测试
3. 优化大型世界的性能

### 长期目标
1. 支持更多结构类型（要塞、神殿等）
2. 自定义道路材料系统
3. 道路网络优化（避免重复路径）
4. 多人游戏完整支持
5. 数据包配置支持

---

## 📞 联系方式

- **GitHub**: [shiroha-233/RoadWeaver](https://github.com/shiroha-233/RoadWeaver)
- **Issues**: [报告问题](https://github.com/shiroha-233/RoadWeaver/issues)

---

## 📄 许可证

本项目采用 **MIT** 许可证，开源且允许商业使用，但需保留原作者版权声明。

---

**最后更新**: 2025-10-10
**项目版本**: 1.0.0
**Minecraft 版本**: 1.21.1
