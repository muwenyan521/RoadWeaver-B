# 数据持久化说明

## ✅ 数据已经保存在存档中

你提到的问题"换个角色进存档，所有结构点都不见了"，实际上**数据已经正确保存**，只是调试地图界面需要刷新。

## 📁 数据存储位置

### **Fabric 版本**
使用 Fabric Attachment API (`AttachmentRegistry.createPersistent`)：
- 数据保存在：`saves/<世界名>/data/attachments/`
- 文件格式：NBT 格式
- 自动随存档保存和加载

### **NeoForge 版本**
使用 NeoForge SavedData 系统：
- 数据保存在：`saves/<世界名>/data/`
- 文件名：
  - `roadweaver_structure_locations.dat`
  - `roadweaver_connected_structures.dat`
  - `roadweaver_road_data.dat`
- 自动随存档保存和加载

## 📊 保存的数据类型

### 1. **结构位置数据** (`StructureLocationData`)
```java
- 结构位置列表 (BlockPos)
- 结构 ID (ResourceLocation)
- 自动持久化到存档
```

### 2. **结构连接数据** (`StructureConnection`)
```java
- 起点和终点位置
- 连接状态 (PLANNED/GENERATING/COMPLETED/FAILED)
- 是否手动连接
- 自动持久化到存档
```

### 3. **道路数据** (`RoadData`)
```java
- 道路宽度
- 道路类型 (人工/自然)
- 道路材料
- 道路路径段列表
- 自动持久化到存档
```

## 🔄 新增：刷新按钮

为了解决界面数据不更新的问题，已添加**刷新按钮**：

### **位置**
- 右上角，配置按钮左侧
- 快捷键：点击"刷新"按钮

### **功能**
- 重新从存档加载最新数据
- 更新结构位置、连接和道路
- **自动清理失败的连接**（FAILED 状态）
- 重新计算地图边界
- 显示"数据已刷新"提示（如有清理会显示数量）

### **使用场景**
1. ✅ 切换角色后，点击刷新查看所有结构
2. ✅ 后台生成了新道路，点击刷新更新显示
3. ✅ 手动添加了新连接，点击刷新查看状态
4. ✅ 清理失败的道路连接，释放存档空间

## 🎯 验证数据持久化

### **测试步骤**
1. 打开调试地图，记录当前结构数量
2. 退出游戏
3. 重新进入存档
4. 打开调试地图，点击"刷新"按钮
5. ✅ 所有结构、连接、道路都应该还在

### **数据文件位置**
你可以在存档文件夹中找到这些数据文件：

**Fabric**:
```
saves/<世界名>/data/attachments/
```

**NeoForge**:
```
saves/<世界名>/data/roadweaver_*.dat
```

## 🐛 常见问题

### Q: 为什么切换角色后结构点不见了？
**A**: 数据其实还在，只是界面没有自动刷新。点击右上角的"刷新"按钮即可。

### Q: 数据会随存档一起备份吗？
**A**: 是的！数据保存在存档的 `data` 文件夹中，备份存档时会一起备份。

### Q: 多人游戏支持吗？
**A**: 数据是按世界（ServerLevel）保存的，多人游戏也支持。但调试地图目前仅支持单人模式。

### Q: 删除存档会删除数据吗？
**A**: 是的，删除存档会同时删除所有道路数据。

## 🔧 技术细节

### **Fabric 实现**
```java
// 注册持久化附件
AttachmentRegistry.createPersistent(
    ResourceLocation.fromNamespaceAndPath("roadweaver", "structure_locations"),
    Records.StructureLocationData.CODEC
);
```

### **NeoForge 实现**
```java
// 使用 SavedData 系统
public class StructureLocationsData extends SavedData {
    @Override
    public CompoundTag save(CompoundTag tag, HolderLookup.Provider provider) {
        // 序列化数据到 NBT
    }
}
```

## 📝 总结

- ✅ **数据已经持久化**：随存档保存，不会丢失
- ✅ **刷新按钮**：手动刷新界面数据
- ✅ **跨平台支持**：Fabric 和 NeoForge 都正确实现
- ✅ **备份安全**：数据随存档一起备份

**你遇到的问题不是数据丢失，而是界面没有自动刷新。现在只需点击"刷新"按钮即可！**
