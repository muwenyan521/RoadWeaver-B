# 线程池优化说明

## 📊 优化内容

### 修改前
- **线程池大小**: 7 线程
- **最大并发数**: 3 个道路生成任务
- **GUI 上限**: 最大 10

### 修改后
- **线程池大小**: 128 线程
- **最大并发数**: 128 个道路生成任务
- **GUI 上限**: 最大 256（可配置）

## 🔧 修改文件清单

### Common 模块
- ✅ `ModEventHandler.java` - 线程池大小 `THREAD_COUNT = 128`

### Fabric 模块
- ✅ `ModEventHandler.java` - 线程池大小 `THREAD_COUNT = 128`
- ✅ `FabricModConfig.java` - 默认值 `maxConcurrentRoadGeneration = 128`
- ✅ `ClothConfigScreen.java` - GUI 默认值 128，最大值 256

### NeoForge 模块
- ✅ `NeoForgeJsonConfig.java` - 默认值 `maxConcurrentRoadGeneration = 128`
- ✅ `ClothConfigScreen.java` - GUI 默认值 128，最大值 256

## 📈 性能提升预期

### 并发能力
| 指标 | 修改前 | 修改后 | 提升倍数 |
|------|--------|--------|----------|
| 线程池大小 | 7 | 128 | **18.3x** |
| 最大并发任务 | 3 | 128 | **42.7x** |
| 理论吞吐量 | 低 | 极高 | **显著提升** |

### 适用场景
- ✅ **大型服务器**: 多个玩家同时触发道路生成
- ✅ **初始化阶段**: 快速生成大量初始道路
- ✅ **高性能硬件**: 充分利用多核 CPU

## ⚠️ 注意事项

### 1. 硬件要求
- **推荐 CPU**: 8 核心以上
- **推荐内存**: 16GB 以上
- **存储**: SSD 推荐（大量 I/O 操作）

### 2. 性能监控
建议监控以下指标：
- CPU 使用率
- 内存占用
- 磁盘 I/O
- TPS（Ticks Per Second）

### 3. 动态调整
如果遇到性能问题，可以通过配置文件或 GUI 降低并发数：
```json
{
  "maxConcurrentRoadGeneration": 64  // 降低到 64
}
```

## 🎯 配置建议

### 低配置服务器（4-8 核心）
```json
{
  "maxConcurrentRoadGeneration": 16
}
```

### 中配置服务器（8-16 核心）
```json
{
  "maxConcurrentRoadGeneration": 64
}
```

### 高配置服务器（16+ 核心）
```json
{
  "maxConcurrentRoadGeneration": 128
}
```

### 超高配置服务器（32+ 核心）
```json
{
  "maxConcurrentRoadGeneration": 256
}
```

## 📝 技术细节

### 线程池类型
```java
ExecutorService executor = Executors.newFixedThreadPool(THREAD_COUNT);
```
- **类型**: 固定大小线程池
- **优点**: 资源可控，避免线程爆炸
- **缺点**: 线程数固定，无法动态扩展

### 任务管理
```java
ConcurrentHashMap<String, Future<?>> runningTasks
```
- **键**: `worldKey_timestamp`
- **值**: 异步任务的 `Future` 对象
- **线程安全**: 使用 `ConcurrentHashMap`

### 并发控制
```java
if (currentRunning >= config.maxConcurrentRoadGeneration()) {
    return;  // 达到上限，等待下一个 tick
}
```

## 🔄 后续优化方向

### 1. 动态线程池
```java
// 根据 CPU 核心数动态调整
int cores = Runtime.getRuntime().availableProcessors();
int threadCount = Math.max(cores * 2, 16);
```

### 2. 优先级队列
- 手动连接优先级更高
- 距离玩家近的连接优先生成

### 3. 自适应并发
- 根据 TPS 动态调整并发数
- TPS < 15 时降低并发
- TPS > 18 时提高并发

### 4. 分布式生成
- 支持多服务器协同生成
- 使用 Redis 或 RabbitMQ 作为任务队列

## 📊 性能测试建议

### 测试场景
1. **初始化测试**: 新世界加载，生成 20 个初始连接
2. **持续负载测试**: 模拟 10 个玩家同时探索
3. **峰值测试**: 短时间内触发大量道路生成

### 监控指标
```
- 平均道路生成时间
- 队列等待时间
- CPU 使用率峰值
- 内存占用峰值
- TPS 波动范围
```

## 🎉 总结

此次优化将线程池大小从 **7 提升到 128**，并发上限从 **3 提升到 128**，理论性能提升超过 **40 倍**。

适合高性能服务器和大型多人游戏场景，但需要根据实际硬件配置进行调整。

**建议**: 首次使用时从较低的并发数开始（如 32），逐步提升至合适的值。
